# IPv4的TCP客户端和IPv6的TCP服务端通信步骤

- IPv6服务器启动后创建一个IPv6的监听套接字，假定服务器把通配地址捆绑到该套接字。
- IPv4客户调用gethostname找到服务器主机的一个A记录。服务器主机既有一个A记录，又有一个AAAA记录，因为它同时支持IPv4和IPv6，不过IPv4客户需要的只有一个A记录。
- 客户调用connect，导致客户主机发送一个IPv4 SYN到服务器主机。
- 服务器主机接收这个目的地为IPv6监听套接字的IPv4 SYN，设置一个标志指示本连接应使用IPv4的IPv6地址，然后响应以一个IPv4 SYN/ACK。该连接建立后，由accept返回给服务器的地址就是这个IPv4映射的IPv6地址。
- 当服务器主机往这个IPv4映射的IPv6地址发送TCP分节时，其IP栈产生的目的地址为所映射IPv4地址的IPv4载送数据报。因此，客户和服务器之间的所有通信都使用IPv4的载送数据报。
- 除非服务器显式检查这个IPv6地址是不是一个IPv4地址映射的IPv6地址（使用IN6_IS_ADDR_V4MAPPED宏），否则它永远不知道自己是在与一个IPv4客户通信。这个细节由协议栈处理。同理，IPv4客户也不知道自己是在与一个IIPv6服务器通信。
- 上述情形的一个假设是：双栈服务器主机既有一个IPv4地址，也有一个IPv6地址。





大多数双栈主机在处理监听套接字时应使用以下规则：

- IPv4监听套接字只能接受来自IPv4客户的外来连接
- 如果服务器有一个绑定了通配地址的IPv6监听套接字，而且该套接字未设置IPV6_V6ONLY套接字选项，那么该套接字既能接受来自IPv4客户的外来连接，又能接受来自IPv6客户的外来连接。对于来自IPv4客户的连接而言，其服务器端的本地地址将是与某个本地IPv4地址对应的IPv4映射的IPv6地址
- 如果服务器有一个IPv6监听套接字，而且绑定在其上的是除IPv4映射的IPv6地址之外的某个某个非通配的IPv6地址，或者绑定在其上的是通配地址，不过还设置了IPV6_V6ONLY套接字选项，那么该套接字只能接受来自IPv6客户的外来连接。