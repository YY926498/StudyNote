# CSAPP第6章笔记

**高速缓存**：是一个小而快速的存储设备，作为存储在更大，也更慢的设备中的数据对象的缓冲区域。使用高速缓存的过程称为**缓存**。

存储器层次结构的中心思想：对于每个k，位于k层的更快更小的存储设备作为位于k+1层的更大更慢的存储设备的缓存。即层次结构中的每一层都缓存来自较低一层的数据对象。

每层的存储器被划分成连续的数据对象组块（chunk)，称为块（block)。每个块都有唯一的地址或名字，使之区别其他的块。数据总是以块大小为传送单元在第k层和第k+1层之间来回复制。相邻层次之间块大小是固定的，但不同层之间的块是不相同的。例如：L1和L0之间传送通常是1个字大小块。L2和L1之间（以及L3和L2…）的传送通常是几十个字大小块。一般而言，层次结构中较低层（离CPU较远）的设备的访问时间较长，因此为了补偿，倾向于使用较大的块。

### 缓存命中

当程序需要第k+1层的某个数据对象d时，它首先在当前存储在第k层的一个块中查找d。如果d刚好缓存在第k层中，那么就是**缓存命中**。

### 缓存不命中

如果第k层中没有缓存对象d，即**缓存不命中**。当发生缓存不命中时，第k层的缓存会从第k+1层缓存中取出d的那个块，如果第k层缓存已满，可能会覆盖一个现存的一个块。

覆盖现存的块的过程称为替换或驱逐这个块。被驱逐的块被称为**牺牲块**。常用的替换策略有：随机替换策略、最近最少被使用（LRU）替换策略、最不常使用（LFU）的策略。

种类：

- 如果第k层的缓存是空的，对任何对象的访问都不会命中，空的缓存被称为冷缓存，此类不命中称为**强制性不命中**或**冷不命中**。放生不命中时，需要执行某个**放置策略**，确定从第k+1层中取出的块放在哪里。第一种是放在任何块中，这种虽然灵活，但是定位起来代价太高。另一种是按照一定规律，比如第k+1层的块i必须放置在第k层的块（i mod 4)中。这种放置策略会引起一种不命中，称为**冲突不命中**。即加入第k层可用的块比较多，但是从第k+1层取出的数据都放在第k层的块i中，因此频繁造成不命中。

### 缓存管理

用于将缓存划分成块，在不同的层之间传送块，判定是命中还是不命中，并处理它们。管理缓存的逻辑可以是硬件。软件或是两者的结合。



存储器的层次结构：利用了时间局部性和空间局部性。



**抖动**：高速缓存反复的加载和驱逐相同的高速缓存块的组。简单的解决方法是：在每个数组的结尾放B字节的填充。令数据映射到不同的组，消除抖动冲突不命中。



编写高速缓存友好的代码：

- 让最常见的情况运行的更快。
- 尽量减少每个循环内部的缓存不命中数量。

- [ ] 对局部变量的反复引用是好的，因为编译器能够将它们缓存在寄存器文件中（时间局部性）
- [ ] 步长为1的引用模式是好的，因为存储器层次结构中所有层次上缓存都是将数据存储为连续的块（空间局部性）。

