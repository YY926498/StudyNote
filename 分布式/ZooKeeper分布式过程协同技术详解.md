# ZooKeeper分布式过程协同技术详解

## ZooKeeper的概念和基础

### 简介

ZooKeeper提供一组简单的API，使得开发人员可以实现通用的协作任务，包括选举主节点、管理组内成员、管理元数据等。ZooKeeper的服务组件运行在一组专用服务器之上，保证了高容错性和可扩展性。

决定使用ZooKeeper来设计应用时，最好将应用数据和协同数据独立开。

#### ZooKeeper的使命

可以在分布式系统中协作多个任务。一个协作任务是指一个包含多个进程的任务。这个任务可以是为了协作或者是为了管理竞争。协作意味着多个进程需要一同处理某些事情，一些进程采取某些行动使得其他进程可以继续工作。竞争指的是两个进程不能同时处理工作的情况。一个进程必须等待另一个进程。

协同并不总是采取像群首选举或者加锁等同步原语的形式。配置元数据也是一个进程通知其他进程需要做什么的一种常用方式。

ZooKeeper客户端API功能强大，包括：

-   保障强一致性、有序性和持久性
-   实现通用的同步原语的能力
-   在实际分布式系统中，并发往往导致不正确的行为。ZooKeeper提供了一种简单的并发处理机制



使用一个独立的协调组件有几个重要的好处：

-   可以独立地设计和实现该组件，这样独立的组件可以跨多个应用共享
-   系统架构师可以简化协作方面的工作
-   系统可以独立地运行和协作这些组件，独立这些组件，简化生产环境中解决实际问题的任务

ZooKeeper使用共享存储模型来实现应用间的协作和同步原语。对于共享存储本身，又需要在进程和存储间进行网络通信。网络通信的是分布式系统中并发设计的基础。

在真实的系统中，需要注意一下问题：

-   消息延迟：消息传输可能发生任意延迟。这种任意延迟可能会导致不可预期的后果。
-   处理器性能：操作系统的调度和超载也可能导致消息处理的任意延迟。
-   时钟偏移：使用时间概念的系统并不少见，时间可能会发生任意的偏移。因此，依赖处理器时钟也许会导致错误的决策。

#### 示例：主-从应用

一般在主-从应用架构中，主节点负责跟踪从节点状态和任务的有效性，并分配任务到从节点。要实现主-从模式的系统，必须解决如下三个关键问题：

-   主节点崩溃：如果主节点发送错误并失效，系统将无法分配新的任务或重新分配已失败的任务。
-   从节点崩溃：如果从节点崩溃，已分配的任务将无法完成。
-   通信故障：如果主节点和从节点之间无法进行信息交换时，从节点将无法得知新任务分配给它。

主节点失效时，需要有一个备份的主节点(backup master)。当主要主节点(primary master)崩溃时，备份主节点接管主要主节点的角色，进行故障转移。此时不是简单开始处理进入主节点的请求。新的主要主节点需要能够恢复到旧的主要主节点崩溃时的状态。对于主节点状态的可恢复性，不能依靠已经崩溃的主节点来获取这些信息，而需要从其他地方获取，即通过ZooKeeper来获取。

另外还有由于网络延迟、网络分区导致脑裂的情况。

**脑裂**：系统中两个或多个部分开始独立工作，导致整体行为不一致性。

需要找出一种处理主节点失效的情况，更重要的是需要避免发生脑裂的情况。

从节点失效：客户端向主节点提交任务后，主节点将任务派发到有效的从节点中。从节点接收到派发的任务，执行完这些任务后会向主节点报告执行状态，主节点下一步会将执行结果通知给客户端。

如果从节点崩溃，主节点需要具有检测从节点崩溃的能力。主节点必须能够检测到从节点的崩溃，并确认哪些从节点是否有效以便派发崩溃节点的任务。一个从节点崩溃时，可以执行了部分任务，也可能全部执行完，但没有报告结果。如果整个运算过程中发生了其他作用，还有必要执行某个恢复过程来清除之前的状态。

通信故障：如果一个从节点与主节点的网络连接断开，比如网络分区导致，重新分配一个任务可能会导致两个从节点执行相同的任务。如果一个任务允许多次执行，在进行任务再分配时可以不用验证第一个从节点是否完成了该任务。如果一个任务不允许，那么应用需要适应多个从节点执行相同任务的可能性。通信故障导致的另一个重要问题是对锁等同步原语的影响。

