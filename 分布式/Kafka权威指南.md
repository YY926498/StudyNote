# Kafka权威指南

## 初始Kafka

### 发布与订阅消息系统

发布者以某种方式对消息进行分类，接收者订阅它们，以便接收特定类型的消息。发布与订阅系统一般会有一个broker，即发布消息的中心点。

### Kafka登场

Kafka一般被称为“分布式提交日志”或者“分布式流平台”。文件系统或数据库提交日志用来提供所有事务的持久记录，通过重放这些日志可以重建系统的状态。数据是按照一定顺序持久化保存的，可以按需读取，并且具备数据故障保护和性能伸缩能力。

#### 消息和批次

Kafka的数据单元被称为**消息**。消息可以有一个可选的元数据，即**键**。键是一个字节数组。当消息以一种可控的方式写入不同的分区时，会用到键。最简单的例子是位键生成一个一致性散列值，然后使用散列值对主题分区数进行取模，为消息进行分区。保证具有相同键的消息总是被写入到相同的分区。

为了提高效率，消息被分批次写入Kafka。**批次**是一组消息，这些消息属于同一个主题和分区。

#### 模式

消息模式是一种结构用于定义消息内容。模式和消息体是分开的，当模式发生变化，不需要重新生成代码，支持强类型和模式进化，版本向前兼容，也向后兼容。

#### 主题和分区

Kafka的消息通过**主题**进行分类。主题类似数据库的表。主题可以被分为若干个**分区**，一个分区就是一个提交日志。消息以追加的方式写入分区，然后以先入先出的顺序读取。一个主题由于含有多个分区，整个主题范围内无法保证消息的顺序，但单个分区内的顺序可以保证。Kafka通过分区来实现数据的冗余和伸缩性。分区可以分布在不同的服务器上，即一个主题可以横跨多个服务器。

通常使用**流**来描述Kafka这类系统的数据。把一个主题的数据看成一个流。流是一组从生产者移动到消费者的数据。

#### 生产者和消费者

Kafka 客户端被分为两种基本的类型：生产者和消费者。

**生产者**创建消息。一般情况下，一个消息会被发布到一个特定的主题上。生产者默认情况下把消息均衡地分布到主题的所有分区上，而不关心特定消息会被写到哪个分区。有时可以通过消息键和分区器来把消息直接写到指定的分区。分区器为键生成一个散列值，并将其映射到指定的分区。从而保证同一个键的消息会被写到同一个分区。生产者也可以使用自定义的分区器，根据不同的业务规则将消息映射到分区。

**消费者**读取消息。订阅一个或多个主题，并将消息生成的顺序读取它们。消费者通过检查消息的偏移量来区分已经读取过的消息。偏移量是另一种元数据，是一个不断递增的整数值，在创建消息时，Kafka会把它添加到消息里。在给定的分区里，每个消息的偏移量都是唯一的。消费者把每个分区最后读取的消息偏移量保存在ZooKeeper或Kafka上，如果消费者关闭或重启，读取状态不会丢失。

消费者是**消费者群组**的一部分。会有一个或多个消费者共同读取一个主题。群组保证每个分区只能被一个消息者使用。比如某些消费者会使用多个分区，但不会出现一个分区被多个消费者读取。消费者与分区之间的映射被称为消费者对分区的所有权关系。

通过这种方式，消费者可以消费包含大量消息的主题。并且一个消费者失效，群组里其他消费者可以接管失效消费者的工作。