# 初始Kafka

kafka扮演如下角色：

1.  消息系统：Kafka和传统的消息系统都具备系统解耦、冗余存储、流量削峰、缓冲、异步通信、扩展性、可恢复性等功能，并且Kafka还提供了消息顺序性保障及回溯消费的功能。
2.  存储系统：Kafka把消息持久化到磁盘，有效降低数据丢失的分享。
3.  流式处理平台：Kafka为流式处理框架提供了可靠的数据来源，并且提供了完整的流式处理类库。

## 基本概念

Kafka体系架构包括若干Producer、若干Broker、若干Consumer以及一个Zookeeper集群。Producer将消息发送到Broker，Broker负责将收到的消息存储到磁盘中，Consumer负责从Broker订阅定消费消息。Zookeeper是Kafka用来负责集群元数据的管理、控制器的选举等操作。

Kafka的消息以主题为单位进行归类，生产者将消息发送到特定的主体，消费者负责订阅主题并进行消费。

主题是逻辑上的概念，可以细分为多个分区，一个分区只属于单个主题。同一个主题下的不同分区包含的消息时不同的，分区在存储层面可以看做一个可追加的日志文件。消息在被追加到分区日志文件的时候都会分配一个特定的偏移量（offset）。offset是消息在分区中的唯一标识，Kafka通过它来保证消息在分区内的顺序性，不过offset不跨越分区，即Kafka保证的是分区有序而不是主题有序。

Kafka为分区引入了多副本(Replica)机制，通过增加副本数量可以提升容灾能力。同一分区的不同副本中保存的是相同的消息，副本之间是“一主多从”的关系，leader副本负责处理读写请求，follower副本只负责与leader服务的消息同步。副本出于不同的broker中，当leader副本出现故障时，从follower副本中重新选举新的leader对外提供服务。Kafka通过多副本机制实现了故障的自动转移，当Kafka集群中某个broker失效时仍然能保证服务可用。

Kafka消费端也具备一定的容灾能力，Consumer使用pull模式从服务端拉取消息，并且保证消费的具体位置，当消费者宕机后恢复上线时可以根据之前保存的消费位置重新拉取需要的消息进行消费。

分区中的所有副本统称为AR(Assigned Replicas)。所有与leader副本保持一定程度同步的副本（包括leader副本在内）组成ISR(In-Sync Replicas)，ISR集合是AR集合中的一个子集。消息会先发送到leader副本，然后follower副本才能从leader服务中拉取消息进行同步。同步期间follower副本相对于leader副本而言有一定程度的滞后。“一定程度的滞后”是指可忍受的滞后范围，可以配置。与leader副本同步滞后过多的副本（不包括leader副本）组成OSR(Out-of-Sync Replicas)，因此AR=ISR+OSR。

leader副本负责维护和跟踪ISR集合中所有follower副本的滞后状态，当follower副本落后太多或失效时，leader副本会把它从ISR集合中剔除。如果OSR集合中有follower副本“追上”了leader副本，那么leader副本会把它从OSR集合中转移到ISR集合。默认情况下，leader副本发生故障时，只有ISR集合中的副本才有资格被选举为新的leader。（这个选举可以配置）

ISR与HW和LEO有紧密的关系。LEO表示当前日志分拣中下一条待写入消息的offset，如果最新的消息offset为9，那么LEO就是10。分区ISR集合中的每个副本都会维护自身的LEO，ISR集合中最小的LEO为分区的HW，消费者只能消费HW之前的消息。

Kafka的复制机制不是完全的同步复制，也不是单纯的异步复制。

# 生产者

生产者是负责向Kafka发送消息的应用程序。发送消息时，会携带如下属性：topic和partition分别表示消息要发往的主题和分区号。headers字段是消息的他头部，用来设定一些与应用无关的消息。key用来指定消息的键，不仅是消息的附加信息，也可以用来计算分区号进而让消息发往特定的分区。同一个key会被划分到同一个分区中，并且有key的消息支持日志压缩的功能。value指消息体，一般不为空，如果为空表示特定的消息-墓碑消息。timestamp表示消息的时间戳，有CreateTime和LogAppendTime两种类型，前者表示消息创建的时间，后者表示消息追加到日志文件的时间。

### 分区器

消息在通过send发往broker的过程中，需要经过拦截器、序列化器、分区器等才能真正发往broker。如果消息中指定了partition的值，就不需要分区器。否则会根据key计算partition的值。分区器的作用是位消息分配分区。

如果key不为null，计算得到的分区号是所有分区中的任意一个；如果key为null，计算得到的分区号仅为可用分区中的任意一个。

一旦改变了分区，不保证key和分区之间的映射关系。

### 拦截器

拦截器分为生产者拦截器和消费者拦截器。

生产者拦截器可以过滤不符合要求的消息、修改消息的内容，也可以在发送回调逻辑前做定制化的需求，比如统计。

## 原理分析

### 生产者参数

acks：用来指定分区中必须要有多少个副本收到这条消息，之后生产者才会认为这条消息是成功写入的。设计消息的可靠性和吞吐量之间的权衡。

1.  acks=1：默认值，生产者发送消息之后，只要分区的leader副本成功写入消息，就会收到来自服务端的成功响应。
2.  acks=0：发送消息之后不需要等待任务服务端的响应，可以达到最大的吞吐量。
3.  acks=-1或all：生产者发送消息之后，需要等待ISR中的所有副本都成功写入消息之后才能够收到来自服务端的成功响应。

# 消费者