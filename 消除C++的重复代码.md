# 消除C++的重复代码

由于C++编译器在很多时候可能产生重复的代码，比如模板，外部内联函数和虚函数表等在不同编译单元里生成相同的代码。如果简单的保留所有代码，就会产生下列问题：

- 空间浪费：如果有很多个编译单元的工程同时实例化许多个模板，最后链接的时候必须将重复的代码消除掉，否则最后的程序的大小肯定会膨胀的厉害。
- 地址较容易出错：有可能两个指向同一个函数的指针会不相等。
- 指令运行效率较低：因为现代的CPU都会对指令和数据缓存，如果同样一份指令有多份副本，那么指令Cache的命中率就会降低。

主流的编译器一般是在不同的编译单元内生成相同的名字，最终链接器在链接时可以区分相同的段，然后合并起来。GCC把这种必须要在最终链接时合并的段叫“link once”。把这种类型的段命名为：“.gnu.linkonce.name”，其中“name”是该实例的修饰后名称。在VISUAL C++里，将这种类型的段叫做“COMDAT”，这种段的属性字段都有IMAGE_SCN_LNK_COMDAT这个标记，在链接器看到这个标记后，它就认为这个段是COMDAT类型的，在链接时会将重复的段丢弃。

这种方法也应用在外部内联函数和虚函数表。这种方法虽然能够基本上解决代码重复的问题，但还是存在一些问题。比如相同名称的段可能拥有不同的内容，这可能由于不同的编译器版本或者编译优化选项，导致同一个函数编译出来的实际代码不同，那么这种情况下链接器可能会做出一个选择，那就是随意选择其中任何一个副本作为链接的输入，然后同时提供一个警告信息。



### 函数级别链接

由于程序和库都比较大，因此有很多没有用到的函数或变量，在编译器里有函数级别链接选项，只将链接器用到的函数和变量合并并输出到文件中，减小输出文件的大小，减少空间浪费。