# 《MySQL技术内幕 InnoDB存储引擎》

## 第1章 MySQL体系结构和存储引擎

MySQL主要由以下几部分组成：

- [ ] 连接池组件
- [ ] 管理服务和工具组件
- [ ] SQL接口组件
- [ ] 查询分析器组件
- [ ] 优化器组件
- [ ] 缓冲组件
- [ ] 插件式存储引擎
- [ ] 物理文件

 MySQL的存储引擎是基于表的，而不是数据库。

### InnoDB存储引擎

InnoDB存储引擎支持事务，其设计目标主要面向在线事务处理（OLTP）的应用。其特点是行锁设计、支持外键，并支持类似于Oracle的非锁定读，即默认读取操作不会产生锁。通过使用多版本并发控制（MVCC）来获得高并发性。

对于表中数据的存储，InnoDB存储引擎采用了聚集的方式，因此每张表的存储都是按主键的顺序进行存放。如果没有显式地在表定义时指定主键，InnoDB存储引擎会为每一行生成一个6字节的ROWID，并以此为主键。

### MyISAM存储引擎

MyISAM存储引擎不支持事务、表锁设计，支持全文索引。一个与众不同的地方是它的缓冲区只缓存（cache)索引文件，而不缓存数据文件。

### NDB存储引擎

特点是数据全部放在内存中，因此主键查找的速度极快，并且通过添加NDB数据存储节点可以线性地提高数据库性能，是高可用、高性能的集群系统。

NDB存储引擎的联结操作（JOIN）是在MySQL数据库层完成的，而不是在存储引擎层完成的。这意味着联结操作需要巨大的网络开销，因此查询速度很慢。

### Memory存储引擎

将表中的数据存放在内存中，如果数据库重启或发生崩溃，表中的数据都将消失。非常适合用于存储临时数据的临时表，以及数据仓库中的纬度表。默认使用的是哈希索引，而不是B+树索引。

只支持表锁，并发性能较差，并且不支持TEXT和BLOB列类型。最重要的是存储变长字段（varchar）时是按照定常字段（char）的方式进行的，因此会浪费内存。

MySQL数据库使用Memory存储引擎作为临时表来存放查询的中间结果集。如果中间结果集大于Memory存储引擎表的容量设置，又或者中间结果含有TEXT或BLOB列类型字段，则MySQL数据库会把其转换到MyISAM存储引擎表而存放到磁盘中。由于MyISAM不缓存数据文件，因此这是产生临时表的性能对于查询会有损失。

### Archive存储引擎

只支持INSERT和SELECT操作，使用zlib算法将数据行（row)进行压缩后存储，压缩比一般达到1:10。非常适合存储归档数据，如日志信息，Archive存储引擎使用行锁来实现高并发的插入操作，但本身并不是食物安全的存储引擎，其设计目标主要是提供高速的插入和压缩功能。

### Federated存储引擎

不存放数据，指示指向一台远程的MySQL数据库服务器上的表。

### Maria存储引擎

设计目标是取代原有的MyISAM存储引擎，从而成为MySQL的默认存储引擎。Maria存储引擎的特点是：支持缓存数据和索引文件，应用了行锁设计，提供了MVCC功能，支持事务和非事务安全的选项，以及更好的BLOB字符类型的处理性能。

---

## 第2章 InnoDB存储引擎

InnoDB是事务安全的MySQL存储引擎。特点是行锁设计、支持MVCC、支持外键、提供一致性非锁定读，同时被设计用来最有效地利用以及使用内存和CPU。

### 后台线程

InnoDB存储引擎是多线程的模型，因此其后台有多个不同的后台线程，负责处理不同的任务。

**Master Thread**

Master Thread是一个非常核心的后台线程，主要负责将缓冲区中的数据一步刷新到磁盘，保证数据的一致性，包括脏页的刷新、合并插入缓冲、UNDO页的回收等。

**IO Thread**

在InnoDB存储引擎中大量使用AIO来处理写IO请求，这样可以大大提高数据库的性能。而IO Thread的工作主要是负责这些IO请求的回调处理。分为四种类型：write、read、insert buffer和log。

**Purge Thread**

当事务提交后，其所使用的undolog可能不在需要，因此需要PurgeThread来回收已经使用并分配的undo页。

**Purge Cleaner Thread**

作用是将之前的脏页的刷新操作都放入到单独的线程中来完成。

### 内存

**缓冲池**

InnoDB存储引擎是基于磁盘存储的，并将其中的记录按照页的方式进行管理。因此可将其视为基于磁盘的数据库系统。在数据库系统中，由于CPU和磁盘速度的差异，基于磁盘的数据库系统通常使用缓冲池技术来提高数据库的整体性能。

缓冲池就是一块内存。在数据库读取页的操作，首先将从磁盘读到的页存放在缓冲池中，这个过程称为将页‘FIX’在缓冲区中、下一次再读到相同的页时，首先判断该页是否在缓冲池中。若在缓冲池中，称该页在缓冲池中被命中，直接读取该页、否则，读取磁盘上的页。

对于数据库中页的修改操作，则首先修改在缓冲池中的页，然后再以一定的频率刷新到磁盘中。通过Checkpoint的机制刷新回磁盘。

综上，缓冲池的大小直接影响数据库的整体性能。由于32位的操作系统的限制，在该系统下最多将该值设置为3G。也可以打开PAE选项来获得最大64G内存的支持。