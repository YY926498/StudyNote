# HTTP概述

## 资源

Web服务器就是Web资源的宿主。Web资源时Web内容的源头。最简单的Web资源就是Web服务器文件系统中的静态文件。总之，所有类型的内容来源都是资源。

### 媒体类型

HTTP会给每种要通过Web传输的对象都打上名为`MIME（多用途因特网邮件扩展）`类型的数据格式标签。

`MIME`类型是一种文本标记，表示一种主要的对象类型和一个特定的子类型，中间由一条斜杠来分割。

-   HTML格式的文本文档由`text/html`类型来标记
-   普通的ASCII文本文档由`text/plain`类型来标记
-   JPEG版本的图片为`image/jpeg`类型
-   GIF格式的图片为`image/gif`类型
-   Apple的`QuickTime`电影为`video/quicktime`类型
-   微软的ppt文件为`application/vnd.ms-powerpoint`类型

还有很多其他的标签。

### URI

每个Web服务器资源都有一个名字，服务器资源名被称为**统一资源标识符（URI）**。URI分为URL和URN两种。

### URL

**统一资源定位符（URL）**是资源标识符最常见的形式。URL描述了一台特定服务器上某资源的特定位置。标准格式包括三个部分：

-   URL的第一部分被称为方案(scheme)，说明了访问资源所使用协议类型。这部分通常就是HTTP协议（http://）
-   第二部分给出了服务器的因特网地址（比如www.baidu.com）
-   其余部分指定了Web服务器上的某个资源（比如：/special/saw-blade.gif）

### URN

**统一资源名（URN）**是作为特定内容的唯一名称使用的，与目前的资源所在地无关。

## 事务

一个HTTP事务由一条（从客户端发往服务器的）请求命令和一个（从服务器发回客户端的）响应结果组成的。这种通信是通过名为HTTP报文(HTTP message)的格式化数据块进行的。

### 方法

HTTP支持几种不同的请求命令，这些命令被称为HTTP方法(HTTP method)。每条HTTP请求报文都包含一个方法。这个方法会告诉服务器要执行什么命令。常见的方法如下：

| HTTP方法 |                       描述                       |
| :------: | :----------------------------------------------: |
|   GET    |           从服务器向客户端发送命名资源           |
|   PUT    | 将来自客户端的数据存储到一个命名的服务器资源中去 |
|  DELETE  |              从服务器中删除命名资源              |
|   POST   |    将客户端数据发送到一个服务器网关应用程序去    |
|   HEAD   |          仅发送命名资源响应中的HTTP首部          |

### 状态码

每条HTTP响应报文返回时都会携带一个状态码。状态码是一个三位数字的代码，告知客户端请求是否成功，或者是否需要采取其他动作。伴随每个数字状态码，HTTP还会发送一条解释性的“原因短语”文本。包含文本短语主要是为了进行描述，所有的处理过程使用的都是数字码。

## 报文

HTTP报文内容：

- **起始行**：报文的第一行就是起始行，在请求报文中用来说明要做些什么，在响应报文中说明出现了什么情况。
- **首部字段**：起始行后面有零个或多个首部字段。每个首部字段都包含一个名字或值，为了便于解析，两者之间用冒号`:`来分割。首部以一个空行结束。添加一个首部字段和添加新行一样简单。
- **主体**：空行之后就是可选的报文主体了，其中包含了所有类型的数据。请求主体中包括了要发送给Web服务器的数据；响应主体中装载了要返回给客户端的数据。起始行和首部字段都是文本形式并且都是结构化的，而主体不同，主体中可以包含任意的二进制数据（比如图片，视频，音轨或者软件程序）。当然，主体中也可以包含文本。

## 连接

### 连接、IP地址及端口号

1.  浏览器从URL中解析出服务器的主机名
2.  浏览器将服务器的主机名转换成服务器的IP地址
3.  浏览器将端口号从URL中解析出来
4.  浏览器建立一条与Web服务器的TCP连接
5.  浏览器向服务器发送一条HTTP请求报文
6.  服务器向浏览器回送一条HTTP响应报文
7.  关闭连接，浏览器显式文档

## Web的结构组件

-   代理：位于客户端和服务器之间的HTTP中间实体
-   缓存：HTTP的仓库，使常用页面的副本可以保存在离客户端更近的地方
-   网关：连接其他应用程序的特殊Web服务器
-   隧道：对HTTP通信报文进行盲转发的特殊代理
-   Agent代理：发起自动HTTP请求的半智能Web客户端

### 代理

接收所有客户端的HTTP请求，并将这些请求转发给服务器（可能会对请求进行修改之后转发）。

### 缓存

Web缓存或代理缓存是一种特殊的HTTP代理服务器，可以将经过代理传送的常用文档复制保存起来。下一个请求同一文档的客户端就可以享受缓存的私有副本所提供的服务。

### 网关

是一种特殊的服务器，作为其他服务器的中间实体使用。通常用于将HTTP流量转换成其他的协议。网关接受请求时就好像自己是资源的源端服务器一样。

### 隧道

隧道是建立起来之后，就会在两条连接之间对原始数据进行盲转发的HTTP应用程序。HTTP隧道通常用来在一条或多条HTTP连接上转发非HTTP数据，转发时不会窥探数据。HTTP隧道的一种通常用途是通过HTTP连接承载加密的安全套接字层(SSL)流量，这样SSL流量可以穿过只允许Web流量通过的防火墙。

### Agent代理

用户Agent代理是代表用户发起的HTTP请求的客户端程序。所有发布Web请求的应用程序都是HTTP Agent代理。



# URL与资源

## URL的语法

~~~http
<scheme>://<user>:<password>@<host>:<port>/<path>;<param>?<query>#<frag>
~~~

### 方案-使用什么协议

方案是规定如何访问指定资源的主要标识符。方案组件必须以一个字母符号开始，有第一个`:`将其与其余部分分割开来。方案名是大小写无关的。

### 主机与端口

主机组件标识了因特网上能够访问资源的宿主机器。端口组件标识了服务器正在监听的网络端口。

### 用户名和密码

~~~http
http://ftp.prep.at.mit.edu/pub	//没有用户名和密码
http://anonymous@ftp.prep.ai.mit.edu/pub	//有用户名但没有密码
http://joe:joespassword@www.joes.com/sales	//同时有用户名和密码
~~~

### 路径

URL的路径组件说明了资源位于服务器的什么地方。路径通常上很像一个分级的文件系统路径。路径是服务器定位资源时所需的信息。可以用字符`/`将HTTP URL的路径组件划分成一些路径段，每个路径段都有自己的参数组件

### 参数

为了向应用程序提供他们所需的输入参数，以便正确地与服务器进行交互，URL中有一个参数组件。这个组件就是URL中的名值对列表，由字符`;`将其与URL的其余部分（以及名值对）分割开来。为应用程序提供了访问资源所需的所有附加信息。

~~~http
ftp://prep.ai.edu/pub/gnu;type=d
~~~

上述例子中，有一个参数type=d，参数名为type，值为d。

### 查询字符串

~~~http
http://www.joes.com/inventory-check.cgi?item=12731
~~~

其中问好`?`右边的内容被称为查询组件。URL的查询组件和标识网关资源的URL路径组件会一起发送给网关资源。查询是否有条目为12731。

另外多个查询可以如下：

~~~http
?item=12731&color=blue	//中间用&分割	
~~~

### 片段

为了引用部分资源或资源的一个片段，URL支持使用片段组件来表示一个资源内部的片段，比如，URL可以指向HTML文档中一个特定的图片或小节。片段挂在URL的右手边，最前面有一个字符`#`。比如：

~~~http
http://www.joes.com/tools.html#drills
~~~

在这个例子中，片段drills引用了/tools.html的一个部分，这部分名字叫做drills。

HTTP服务器通常只处理整个对象，而不是对象片段，客户端不能将片段传送给服务器。浏览器从服务器获得了整个资源之后，会根据片段来显式你感兴趣的那部分资源。

## URL快捷方式

### 相对URL

URL分为绝对的和相对的。

1.  基础URL：将相对URL转换为绝对URL，第一步就是找到基础URL。基础URL是作为相对URL的参考点使用的。可以来自以下几部分：

-   在资源中显式提供：HTML文档中包含基础URL的HTML标记`<Base>`，以此来转换所有相对URL
-   封装资源的基础URL：将它所属的资源的URL作为基础
-   没有基础URL：此时是一个不完整或损坏了的URL

2.  解析相对引用

### 自动扩展URL

-   主机名扩展
-   历史扩展

## 各种令人头疼的字符

### URL字符集

包含转义序列及US-ASCII字符集

### 编码机制

通过“转义”表示法来表示不安全字符，包含一个`%`后面跟着两个表示字符ASCII码的十六进制数。比如：

| 字符 |  ASCII码  |                 示例                  |
| :--: | :-------: | :-----------------------------------: |
|  ~   | 126(0X7E) |      http://www.joes.com/%7Ejoe       |
| 空格 | 32(0X20)  | http://www.joes.com/more%20tools.html |
|  %   | 37(0X25)  |  http://www.joes.com/100%25sat.html   |

### 字符限制

| 字符  |               保留/受限                |
| :---: | :------------------------------------: |
|   %   |       保留作为编码字符的转义标志       |
|   /   |  保留作为路径组件中分割路径段的定界符  |
|   .   |          保留在路径组件中使用          |
|  ..   |          保留在路径组件中使用          |
|   #   |         保留作为分段定界符使用         |
|  ？   |      保留作为查询字符串定界符使用      |
|   ;   |         保留作为参数定界符使用         |
|  $,+  |                  保留                  |
| @ & = | 在某些方案的上下文中有特殊的含义，保留 |



# HTTP报文

## 报文流

HTTP报文是在HTTP应用程序之间发送的数据块。这些数据块以一些文本形式的元信息开头，这些信息描述了报文的内容及含义，后面跟着可选的数据部分。术语**流入**、**流出**、**上游**、**下游**都是用来描述报文的方向。

### 报文流入源端服务器

HTTP使用术语**流入**和**流出**来描述**事务处理**的方向。报文流入源端服务器，工作完成之后，会流回用户的Agent代理中。

### 报文向下游流动

不管是请求报文还是响应报文，所有报文都会向下游流动。所有报文的发送者都在接收者的上游。

## 报文组成部分



每条报文都由三部分组成：对报文进行描述的起始行、包含属性的首部块，以及可选的、包含数据的主体部分。

起始行和首部就是由行分割的ASCII文本。每行都以一个由两个字符组成的行终止符序列作为结束，其中包括一个回车符(ASCII码13)和一个换行符（ASCII码10）。这个行终止序列可以写作CRLF。但有时也可能只有单个换行符作为行的终止。

实体的主体或报文的主体是一个可选的数据块。与起始行和首部不同的是，主体中可以包含文本或二进制数据，也可以为空。

### 报文的语法

所有的HTTP报文可以分为两类：请求报文和响应报文

请求报文会向Web服务器请求一个动作。响应报文会将请求的结果返回给客户端。请求和响应的基本报文结构相同。

各部分简要描述：

-   方法（method）：客户端希望服务器对资源执行的动作。是一个单独的词，比如GET、HEAD或者POST。
-   请求URL：命名了所请求资源，或者URL路径组件的完整URL。
-   版本（version）：报文所使用的HTTP版本，其格式如下：

~~~http
HTTP/<major>.<minor>
~~~

其中主要版本号(major)和次要版本号(minor)都是整数。

-   状态码（status-code）：三位数字描述请求过程中所发生的情况。每个状态码的第一位数字都用于描述状态的一般类别（“成功”、“出错”等）。
-   原因短语：数字状态码的可读版本，包含行终止序列之前的所有文本。
-   首部（header）：可以有零个或多个首部，每个首部都包含一个名字，后面跟着冒号`:`，然后是一个可选的空格，接着是一个值，最后是CRLF。首部是有一个空行（CRLF）结束的，表示了首部列表的结束和实体主体部分的开始。
-   实体的主体部分：包含一个由任意数组组成的数据块。有时只是以一个CRLF结束。

注意：一组HTTP首部总是以一个空行结束，甚至即使没有首部和实体的主体部分也应如此。但有时会没有。

### 起始行

请求报文的起始行说明要做什么，响应报文的起始行说明发生了什么。

1.  请求行：请求服务器对资源进行一些操作。请求报文的起始行，称为请求行，包含一个方法和一个请求URL，这个方法描述了服务器应该执行的操作，请求URL描述了要对哪个资源执行这个方法。请求行中还包含HTTP的版本，用来告知服务器，客户端使用的是哪种HTTP。所有字段都是由空格符分隔。
2.  响应行：包含响应报文使用的HTTP版本、数字状态码以及描述操作状态的文本形式的原因短语。所有这些字段都由空格进行分隔。
3.  方法：请求的起始行以方法作为开始，方法用来告知服务器要做什么。常用的HTTP方法如下：

|  方法   |                        描述                        | 是否包含主体 |
| :-----: | :------------------------------------------------: | :----------: |
|   GET   |                从服务器获取一份文档                |      否      |
|  HEAD   |              只从服务器获取文档的首部              |      否      |
|  POST   |             向服务器发送需要处理的数据             |      是      |
|   PUT   |           将请求的主体部分存储在服务器上           |      是      |
|  TRACE  | 对可能经过代理服务器传送到服务器上去的报文进行追踪 |      否      |
| OPTIONS |           决定可以在服务器上执行哪些方法           |      否      |
| DELETE  |               从服务器上删除一份文档               |      否      |

另外还有自己设计的方法，称为扩展方法。

4.  状态码：用来告诉客户端，发生了什么事情。状态码是在每条响应报文的起始行中返回的。会返回一个数字状态和一个可读的状态。数字码便于程序进行差错处理，而原因短语则更便于人们理解。状态码分类：

| 整体范围 | 已定义范围 |    分类    |
| :------: | :--------: | :--------: |
| 100-199  |  100-101   |  信息提示  |
| 200-299  |  200-206   |    成功    |
| 300-399  |  300-305   |   重定向   |
| 400-499  |  400-415   | 客户端错误 |
| 500-599  |  500-505   | 服务器错误 |

如果收到不认识的状态码，根据其所处的范围，将它作为那个类别中一个普通的成员来处理。

5.  原因短语：响应起始行的最后一个组件。为状态码提供文本形式的解释。
6.  版本号：版本号以`HTTP/x.y`的形式出现在请求和响应报文的起始行中。

### 首部

1.  首部分类：除标准外，可以自定义首部

    -   通用首部：既可以出现在请求报文中，也可以出现在响应报文中
    -   请求首部：提供更多有关请求的信息
    -   响应首部：提供更多有关响应的信息
    -   实体首部：描述主体的长度和内容，或者资源自身
    -   扩展首部：规范中没有定义的新首部

    每个HTTP首部都有一种简单的语法：名字后面跟着冒号`:`，然后跟上可选的空格，再跟上字段值，最后是一个CRLF。

    2.首部延续行：将长的首部分为多行可以提高可读性，多出来的每行前面至少需要有一个空格或制表符

### 实体的主体部分
HTTP报文的第三部分是可选的实体主体部分。实体的主体是HTTP报文的负荷，就是HTTP要传输的内容。

## 方法

### GET

通常用于请求服务器发送某个资源。

### HEAD

允许客户端在未获取实际资源的情况下，对资源的首部进行检查，使用HEAD，可以：

-   在不获取资源的情况下了解资源的情况（比如，判断其类型）
-   通过查看响应中的状态码，查看对象是否存在
-   通过查看首部，测试资源是否被修改

### PUT

让服务器用请求的主体部分来创建一个由所请求的URL命名的新文档，或者如果已存在，就用新主体替代。

### POST

起初是用来向服务器输入数据。

### TRACE

允许客户端在最终将请求发送给服务器时，看看它变成了什么样子。

会在目的服务器端发起一个“环回”诊断。行程最后一站的服务器会弹回一条TRACE响应，并在响应主体中携带它收到的原始请求报文。主要用于诊断，但是假定中间应用程序对各种不同类型请求的处理是相同的。TRACE请求中不能带有实体的主体部分。TRACE响应的实体主体部分包含了响应服务器收到的请求的精确副本。

### OPTIONS

请求Web服务器告知其支持的各种功能。

### DELETE

请服务器删除请求URL所指定的资源。

## 状态码

| 状态码 |                             含义                             |
| :----: | :----------------------------------------------------------: |
|  100   | 说明收到了请求的初始部分，请客户端继续。发送了这个状态码之后，服务器在收到请求之后必须进行响应 |
|  101   | 说明服务器正在根据客户端的指定，将协议切换成Uodate首部所列的协议 |

100 Continue状态码：HTTP客户端应用程序有一个实体的主体部分要发送给服务器，但希望在发送之前查看一下服务器是否会接受这个实体。这是一种优化。

如果服务器收到了一条带有值为100 Continue的Expect首部的请求，会用100 Continue响应或发送一条错误码来进行响应。服务器永远不应该向没有发送100 Continue期望的客户端发送100 Continue状态码。

### 200~299成功状态码

|    状态码    |                             含义                             |
| :----------: | :----------------------------------------------------------: |
|    200 OK    |        请求没有问题，实体的主体部分包含了所请求的资源        |
|  201 Create  | 用于创建服务器对象的请求（比如，PUT）。响应的实体主体部分中应该包含各种引用了已创建的资源的URL，Location首部包含的则是最具体的引用。服务器必须在发送这个状态码之前创建好对象 |
| 202 Accepted | 请求已被接受，但是服务器还未执行任何动作。不能保证服务器会完成这个请求 |
|     203      | 实体受不包含的信息不是来自于源端服务器，而是来自资源的一份副本 |
|     204      | 响应报文中包含若干首部和一个状态行，但没有实体的主体部分。主要用于在浏览器不转为显式新文档的情况下，对其进行更新 |
|     205      |        负责告知浏览器清除当前页面中的所有HTML表单元素        |
|     206      |                成功执行了一个部分或range请求                 |

### 300~399重定向状态码