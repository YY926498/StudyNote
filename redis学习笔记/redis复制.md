# redis复制

复制可以让其他服务器拥有一个不断更新的数据副本，从而使得拥有数据副本的服务器可以用于处理客户端发送的读请求。

如果在启动redis服务器时，指定了一个包含`SLAVEOF HOST PORT`选项的配置文件，那么redis服务器将根据这个选项给定的IP地址和端口号来连接主服务器。对于一个正在运行的redis从服务器，用户可以通过发送`SLAVEOF NO ONE`命令来让服务器终止复制操作，不再接受主服务器的数据更新；也可以通过发送`SLAVEOF HOST PORT`命令来让服务器开始复制一个新的主服务器。

### redis复制的启动过程

| 步骤 |                         主服务器操作                         |                         从服务器操作                         |
| :--: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  1   |                         等待命令进入                         |            连接(或者重连接)主服务器，发送SYNC命令            |
|  2   | 开始执行`BGSAVE`命令，并使用缓冲区记录`BGSAVE`之后执行的所有写命令 | 根据配置选项来决定是继续使用现有的数据来处理客户端的命令请求，还是想发送请求的客户端返回错误 |
|  3   | `BGSAVE`执行完毕，向从服务器发送快照文件，并在发送期间继续使用缓冲区记录被执行的写命令 |        丢弃所有旧数据，开始载入主服务器发来的快照文件        |
|  4   |  快照文件发送完毕，开始向从服务器发送存储在缓冲区内的写命令  |      完成快照文件的解释操作，像往常一样开始接受命令请求      |
|  5   | 缓冲区存储的写命令发送完毕；从现在开始，每执行一个写命令，就向从服务器发送相同的写命令 | 执行主服务器发来的所有存储在缓冲区里面的写命令；并从现在开始，接收并执行主服务器传来的写命令 |

需要注意的是：从服务器在同步时，会清空所有自己的数据。并且redis不支持主主复制。

当一个新的从服务器连接一个已有从服务器的主服务器时，有时可重用已有的快照文件

- 当步骤3尚未执行时，所有从服务器都会接收到相同的快照文件和相同的缓冲区写命令
- 当步骤3正在执行或已经执行完毕时，较早进行连接的从服务器执行完复制的5个步骤之后，主服务器会与新的从服务器执行一次新的步骤1-步骤5



### 主从链

redis的从服务器可以拥有自身的从服务器，并由此形成主从链。从服务器对从服务器进行复制操作的唯一区别在于：从服务器X拥有从服务器Y，那么当从服务器X在执行步骤4时，它将断开与从服务器Y的连接，导致从服务器Y需要重新连接并重新同步。

如果读请求的数量远远超出一台redis服务器可以处理的范围内，可以创建一个由redis主从节点组成的中间层来分担主服务器的复制工作。