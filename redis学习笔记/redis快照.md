# redis快照

配置选项：

~~~c
save 60 1000
stop-writes-on-bgsave-error no
rdbcompression yes
dbfilename dump.rdb
dir ./
~~~

将存在于某一时刻的所有数据都写入到硬盘中。

根据配置，快照将被写入到dbfilename选项指定的文件里面，并储存在dir选项指定的路径上面。但是如果在新的快照文件创建完毕之前，Redis、系统或硬件这三者任意一个发生崩溃，那么redis将丢失最近一次创建快照之后写入的所有数据。

例如：假设redis目前在内存里面存储有10G数据，上一个快照是在下午2:34创建的，并且创建成功。下午3:06时，redis又开始创建新的快照，并且在3:08快照文件创建完毕之前，有35个键进行了更新。如果在下午3:06至下午3:08期间，系统发生崩溃，导致redis无法完成新快照的创建工作，那么redis将丢失下午2:34之后写入的所有数据。如果系统恰好在新的快照文件创建完毕之后崩溃，那么redis将只丢失35个键的更新数据。



### 创建快照的方法

- 客户端通过向redis发送`BGSAVE`命令来创建一个快照。对于支持`BGSAVE`命令的平台来说（基本上所有平台都支持，windows目前也支持),redis会调用fork来创建一个子进程，然后子进程负责将快照写入硬盘，而父进程则继续处理命令请求。
- 客户端还可以向redis发送`SAVE`命令来创建一个快照，接到`SAVE`命令的redsi服务器在快照创建完成之前将不再响应任何其他命令。`SAVE`命令不常用，通常只会在没有足够内存去执行`BGSAVE`命令的情况下，又或者即使等待持久化操作执行完毕也无所谓的情况下，才会使用这个命令。
- 如果用户设置了`SAVE`选项，如果`SAVE 60 10000`，那么从redis最近一次创建快照之后算起，当‘60秒之内有10000次写入’这个条件满足时，redis将会自动触发`BGSAVE`命令。如果用户设置了多个`SAVE`选项，那么当任意一个`SAVE`选项被满足时，redis就会触发一次`BGSAVE`命令。
- 当redis通过`SHUTDOWN`命令接收到到关闭服务器的请求时，或者接收到标准`TERM`信号时，会执行一个`SAVE`命令，阻塞所有客户端，不再执行客户端发送的任何命令，并在`SAVE`命令执行完毕之后关闭服务器
- 当一个redis服务器连接另一个redis服务器，并向对方发送`SYNC`命令来开始一次复制操作的时候，如果主服务器目前没有在执行`BGSAVE`操作，或者主服务器并非刚刚执行完`BGSAVE`操作，那么主服务器就会执行`BGSAVE`命令。

由于`BGSAVE`需要创建子进程来生成快照，如果数据量比较大时，由于生成子进程及资源竞争的影响，会比`SAVE`命令慢，可以考虑在没有数据更新的情况下，使用`SAVE`命令来生成快照。