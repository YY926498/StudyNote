# redis计数信号量

计数信号量是一种锁，可以让用户限制一项资源最多能够同时被多少个进程访问，通常用于限定能够同时使用的资源数量。

### 基本的计数信号量

实现超时限制特性一般有两种方法：

- 使用`EXPIRE`命令
- 使用有序集合。

### 使用有序集合来制作计数信号量

为每个进程生成UUID作为成分，并且将申请信号量的时间戳作为分值。

每次申请信号量时，首先删除过时的信号量，然后加入有序集合，判断是否超过限制，如果超出限制就删掉自身。

释放操作只需要从有序集合里删除自身即可。

但是有可能出现不同主机上的时间戳不同，因此这种信号量时不公平的。

### 公平信号量

为信号量额外添加一个计数器，确保最先对计数器执行自增操作的客户端能够获得信号量。将计数器生成的值作为分值，存储到信号量所有权有序集合中。

### 消除竞争条件

使用带有短暂超时的分布式锁，如果程序成功取得了锁，就会执行正常的信号量获取操作，否则，获取失败。