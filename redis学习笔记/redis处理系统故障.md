# redis处理系统故障

传统关系数据库提供了ACID保证。ACID：原子性、一致性、隔离性和耐久性。如果一个数据库想要实现可靠的数据事务，就必须保证ACID保证。

但是redis没有ACID保证，因此需要多做一些工作才能保证数据的一致性。

### 验证快照文件和AOF文件

命令行工具：

~~~c
redis-check-aof
redis-check-dump
~~~

如果修复aof文件，输入`redis-check-aof --fix`。扫描给定的aof文件，寻找不正确的或者不完整的命令，当发现第一个出错的命令的时候，程序会删除出错的命令一个出错命令之后的所有命令，只保留出错命令之前的命令。

目前还没有修复快出错的快照文件。

### 更换故障主服务器

如果一个主服务器A和一个从服务器B。如果主服务器A因为故障而断开了网络连接，可以用同样安装了redis的服务器C作为新的主服务器。首先向机器B发送一个`SAVE`命令，让它创建一个快照文件，接着将这个快照文件发送给机器C，并在机器C上面启动redis。最后让机器B称为机器C的从服务器。

理由：因为机器B本来就是一个从服务器，所以我们的客户端不能对他进行写入，并且在机器B执行快照操作之后，我们的客户端也不会与其他试图对机器B进行写入的客户端产生竞争条件。

另一种方法是将从服务器升级为主服务器，并为升级后的主服务器创建从服务器。

#### redis sentinel可以监视指定的redis主服务器及其属下的从服务器，并在主服务器下线时自动进行故障转移。